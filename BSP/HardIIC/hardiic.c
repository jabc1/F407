/**
  *****************************************************************************
  *                             STM32Ó²¼şIIC¿ØÖÆº¯Êı
  *
  *                       (C) Copyright 2000-2020, ***
  *                             All Rights Reserved
  *****************************************************************************
  *
  * @File    : hardiic.c
  * @By      : ³Â¹ğ¶«
  * @Version : V1.0
  * @Date    : 2016 / 03 / 08
  *
  *****************************************************************************
  *
  *                                   Update
  *
  * @Version : V1.*
  * @By      : ***
  * @Date    : 20** / ** / **
  * @Brief   : ***
  *
  *****************************************************************************
**/


#include "hardiic.h"


/**
  *****************************************************************************
  * @Name   : Ó²¼şIIC³õÊ¼»¯
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:           IIC×é
  *           SlaveAdd:       ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           F103IIC1_Remap: Õë¶ÔF103µÄIIC1ÊÇ·ñÖØÓ³Éä
  *                           0: ²»ÖØÓ³Éä
  *                           1: ÖØÓ³Éä¡£PB.06 -> PB.08£»PB.07 -> PB.09
  *
  * @Output : none
  *
  * @Return : none
  *****************************************************************************
**/
void Hard_IIC_Init(I2C_TypeDef* IICx, u8 SlaveAdd, u8 F103IIC1_Remap/* Õë¶ÔF103µÄIIC1ÖØÓ³ÉäµÄ */)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	I2C_InitTypeDef I2C_InitStructure;
	
#if __CORTEX_M == 0x03  //Cortex-M3
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);
	if (IICx == I2C1)
	{
		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1, ENABLE);
		
		//
		//³õÊ¼»¯¹Ü½Å
		//
		if (F103IIC1_Remap)
		{
			GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_8 | GPIO_Pin_9;
		}
		else
		{
			GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_6 | GPIO_Pin_7;
		}
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
		GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_AF_OD;
		GPIO_Init(GPIOB, &GPIO_InitStructure);
	}
	else if (IICx == I2C2)
	{
		RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE);
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C2, ENABLE);
		
		//
		//³õÊ¼»¯¹Ü½Å
		//
		GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_10 | GPIO_Pin_11;
		GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
		GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_AF_OD;
		GPIO_Init(GPIOB, &GPIO_InitStructure);
	}
	
#elif __CORTEX_M == 0x04  //Cortex-M4
	
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE);
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1, ENABLE);
	
	GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_8 | GPIO_Pin_9;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_AF;
	GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;
	GPIO_InitStructure.GPIO_PuPd  = GPIO_PuPd_NOPULL;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
	
	//
	//¹Ü½Å¸´ÓÃ
	//
	GPIO_PinAFConfig(GPIOB, GPIO_PinSource8, GPIO_AF_I2C1);
	GPIO_PinAFConfig(GPIOB, GPIO_PinSource9, GPIO_AF_I2C1);
	
#endif
	
	//
	//ÅäÖÃIIC²ÎÊı
	//
	I2C_InitStructure.I2C_Mode                = I2C_Mode_I2C;
	I2C_InitStructure.I2C_DutyCycle           = I2C_DutyCycle_2;
	I2C_InitStructure.I2C_OwnAddress1         = SlaveAdd;  //´ÓÉè±¸µØÖ·
	I2C_InitStructure.I2C_Ack                 = I2C_Ack_Enable;
	I2C_InitStructure.I2C_AcknowledgedAddress = I2C_AcknowledgedAddress_7bit;
	I2C_InitStructure.I2C_ClockSpeed          = (100 * 1000);  //SCL×î´ó100KHz
	
	
	I2C_Cmd(IICx, ENABLE);
	I2C_Init(IICx, &I2C_InitStructure);
	I2C_AcknowledgeConfig(IICx, ENABLE); 
	
	//
	//½ûÖ¹Ê±ÖÓÑÓ³¤
	//
	IICx->CR1 |= 1<<7;
}

/**
  *****************************************************************************
  * @Name   : Ó²¼şIICµÈ´ı´ÓÉè±¸ÄÚ²¿²Ù×÷Íê³É
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:     IIC×é
  *           SlaveAdd: ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           ReadAdd:  ¶ÁÈ¡µÄEEPROMÄÚ´æµØÖ·
  *
  * @Output : *err:     ·µ»ØµÄ´íÎóÖµ
  *
  * @Return : ¶ÁÈ¡µ½µÄÊı¾İ
  *****************************************************************************
**/
void Hard_IICWaiteStandby(I2C_TypeDef* IICx, uint8_t SlaveAdd)
{
	u16 tmp = 0;
	
	IICx->SR1 &= 0x0000;  //Çå³ı×´Ì¬¼Ä´æÆ÷1
	
	do
	{
		I2C_GenerateSTART(IICx, ENABLE);  //²úÉúÆğÊ¼ĞÅºÅ
		tmp = IICx->SR1;  //¶ÁÈ¡SR1¼Ä´æÆ÷£¬È»ºóĞ´ÈëÊı¾İ¼Ä´æÆ÷²Ù×÷À´Çå³ıSBÎ»£¬EV5
		I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Transmitter);  //·¢ËÍ´ÓÉè±¸µØÖ·
	} while ((IICx->SR1 & 0x0002) == 0x0000);  //µ±ADDR = 1Ê±£¬±íÃ÷Ó¦´ğÁË£¬Ìø³öÑ­»·
	I2C_ClearFlag(IICx, I2C_FLAG_AF);  //Çå³ıÓ¦´ğÊ§°Ü±êÖ¾Î»
	I2C_GenerateSTOP(IICx, ENABLE);  //·¢ËÍÍ£Ö¹ĞÅºÅ
}

/**
  *****************************************************************************
  * @Name   : Ó²¼şIIC·¢ËÍÒ»¸ö×Ö½ÚÊı¾İ
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:     IIC×é
  *           SlaveAdd: ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           WriteAdd: Ğ´ÈëEEPROMÄÚ´æµØÖ·
  *           Data:     Ğ´ÈëµÄÊı¾İ
  *
  * @Output : *err:     ·µ»ØµÄ´íÎóÖµ
  *
  * @Return : none
  *****************************************************************************
**/
void Hard_IICWriteOneByte(I2C_TypeDef* IICx, uint8_t SlaveAdd, u8 WriteAdd, u8 Data, u8 * err)
{
	u16 temp = 0;
	u16 flag = 0;
	
	while (I2C_GetFlagStatus(IICx, I2C_FLAG_BUSY))  //µÈ´ıIIC
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<0;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	
	I2C_GenerateSTART(IICx, ENABLE);  //²úÉúÆğÊ¼ĞÅºÅ
	temp = 0;
	//
	//EV5
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_MODE_SELECT))
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<1;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	
	I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Transmitter);  //·¢ËÍÉè±¸µØÖ·
	temp = 0;
	//
	//EV6
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
	{
		temp++;
		if (temp > 1000)
		{
			*err |= 1<<2;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	//
	//¶ÁÈ¡SR2×´Ì¬¼Ä´æÆ÷
	//
	flag = IICx->SR2;  //Èí¼ş¶ÁÈ¡SR1¼Ä´æÆ÷ºó,¶ÔSR2¼Ä´æÆ÷µÄ¶Á²Ù×÷½«Çå³ıADDRÎ»£¬²»¿ÉÉÙ£¡£¡£¡£¡£¡£¡£¡£¡£¡
	
	I2C_SendData(IICx, WriteAdd);  //·¢ËÍ´æ´¢µØÖ·
	temp = 0;
	//
	//EV8
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_TRANSMITTING))
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<3;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_SendData(IICx, Data);  //·¢ËÍÊı¾İ
	temp = 0;
	//
	//EV8_2
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_TRANSMITTED))
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<4;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
}

/**
  *****************************************************************************
  * @Name   : Ó²¼şIIC¶ÁÈ¡Ò»¸ö×Ö½ÚÊı¾İ
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:     IIC×é
  *           SlaveAdd: ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           ReadAdd:  ¶ÁÈ¡µÄEEPROMÄÚ´æµØÖ·
  *
  * @Output : *err:     ·µ»ØµÄ´íÎóÖµ
  *
  * @Return : ¶ÁÈ¡µ½µÄÊı¾İ
  *****************************************************************************
**/
u8 Hard_IIC_ReadOneByte(I2C_TypeDef* IICx, uint8_t SlaveAdd, u8 ReadAdd, u8 * err)
{
	u16 i = 0;
	u8 temp = 0;
	u16 flag = 0;
	
	while (I2C_GetFlagStatus(IICx, I2C_FLAG_BUSY))  //µÈ´ıIIC
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<0;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	I2C_GenerateSTART(IICx, ENABLE);  //·¢ËÍÆğÊ¼ĞÅºÅ
	i = 0;
	//
	//EV5
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_MODE_SELECT))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<1;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Transmitter);  //·¢ËÍÉè±¸µØÖ·
	i = 0;
	//
	//EV6
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<2;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	flag = IICx->SR2;  //Èí¼ş¶ÁÈ¡SR1¼Ä´æÆ÷ºó,¶ÔSR2¼Ä´æÆ÷µÄ¶Á²Ù×÷½«Çå³ıADDRÎ»£¬²»¿ÉÉÙ£¡£¡£¡£¡£¡£¡£¡£¡£¡
	
	I2C_SendData(IICx, ReadAdd);  //·¢ËÍ´æ´¢µØÖ·
	i = 0;
	//
	//EV8
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_TRANSMITTING))
	{
		i++;
		if (i > 2000)
		{
			*err |= 1<<3;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	I2C_GenerateSTART(IICx, ENABLE);  //ÖØÆôĞÅºÅ
	i = 0;
	//
	//EV5
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_MODE_SELECT))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<4;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Receiver);  //¶ÁÈ¡ÃüÁî
	i = 0;
	//
	//EV6
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<5;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	flag = IICx->SR2;
	
	I2C_AcknowledgeConfig(IICx, DISABLE);  //·¢ËÍNACK
	I2C_GenerateSTOP(IICx, ENABLE);
	i = 0;
	//
	//EV7
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_RECEIVED))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<6;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return 0;
		}
	}
	temp = I2C_ReceiveData(IICx);
	I2C_AcknowledgeConfig(IICx, ENABLE);
	
	return temp;
}

/**
  *****************************************************************************
  * @Name   : Ó²¼şIIC·¢ËÍ¶à¸ö×Ö½ÚÊı¾İ
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:       IIC×é
  *           SlaveAdd:   ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           WriteAdd:   Ğ´ÈëEEPROMÄÚ´æÆğÊ¼µØÖ·
  *           NumToWrite: Ğ´ÈëÊı¾İÁ¿
  *           *pBuffer:   Ğ´ÈëµÄÊı¾İ×é»º´æ
  *
  * @Output : *err:     ·µ»ØµÄ´íÎóÖµ
  *
  * @Return : none
  *****************************************************************************
**/
void Hard_IIC_WriteNByte(I2C_TypeDef * IICx, u8 SlaveAdd, u8 WriteAdd, u8 NumToWrite, u8 * pBuffer, u8 * err)
{
	u16 sta = 0;
	u16 temp = 0;
	
	while (I2C_GetFlagStatus(IICx, I2C_FLAG_BUSY))  //µÈ´ıIIC
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<0;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_GenerateSTART(IICx, ENABLE);  //²úÉúÆğÊ¼ĞÅºÅ
	temp = 0;
	//
	//EV5
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_MODE_SELECT))
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<1;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Transmitter);  //·¢ËÍÉè±¸µØÖ·
	temp = 0;
	//
	//EV6
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
	{
		temp++;
		if (temp > 1000)
		{
			*err |= 1<<2;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	//
	//¶ÁÈ¡SR2×´Ì¬¼Ä´æÆ÷
	//
	sta = IICx->SR2;  //Èí¼ş¶ÁÈ¡SR1¼Ä´æÆ÷ºó,¶ÔSR2¼Ä´æÆ÷µÄ¶Á²Ù×÷½«Çå³ıADDRÎ»£¬²»¿ÉÉÙ£¡£¡£¡£¡£¡£¡£¡£¡£¡
	I2C_SendData(IICx, WriteAdd);  //·¢ËÍ´æ´¢µØÖ·
	temp = 0;
	//
	//EV8
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_TRANSMITTING))
	{
		temp++;
		if (temp > 800)
		{
			*err |= 1<<3;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	//
	//Ñ­»··¢ËÍÊı¾İ
	//
	while (NumToWrite--)
	{
		I2C_SendData(IICx, *pBuffer);  //·¢ËÍÊı¾İ
		pBuffer++;
		temp = 0;
		//
		//EV8_2
		//
		while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_TRANSMITTED))
		{
			temp++;
			if (temp > 800)
			{
				*err |= 1<<4;
				I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
				return;
			}
		}
	}
	I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
}

/**
  *****************************************************************************
  * @Name   : Ó²¼şIIC¶ÁÈ¡¶à¸ö×Ö½ÚÊı¾İ
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:      IIC×é
  *           SlaveAdd:  ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           ReadAdd:   ¶ÁÈ¡µÄEEPROMÄÚ´æÆğÊ¼µØÖ·
  *           NumToRead: ¶ÁÈ¡ÊıÁ¿
  *
  * @Output : *pBuffer: Êı¾İÊä³ö»º³åÇø
  *           *err:     ·µ»ØµÄ´íÎóÖµ
  *
  * @Return : ¶ÁÈ¡µ½µÄÊı¾İ
  *****************************************************************************
**/
void Hard_IIC_PageRead(I2C_TypeDef* IICx, uint8_t SlaveAdd, u8 ReadAdd, u8 NumToRead, u8 * pBuffer, u8 * err)
{
	u16 i = 0;
	u16 temp = 0;
	u16 sta = 0;
	
	while (I2C_GetFlagStatus(IICx, I2C_FLAG_BUSY))  //µÈ´ıIIC
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<0;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_GenerateSTART(IICx, ENABLE);  //·¢ËÍÆğÊ¼ĞÅºÅ
	i = 0;
	//
	//EV5
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_MODE_SELECT))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<1;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Transmitter);  //·¢ËÍÉè±¸µØÖ·
	i = 0;
	//
	//EV6
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<2;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	sta = IICx->SR2;  //Èí¼ş¶ÁÈ¡SR1¼Ä´æÆ÷ºó,¶ÔSR2¼Ä´æÆ÷µÄ¶Á²Ù×÷½«Çå³ıADDRÎ»£¬²»¿ÉÉÙ£¡£¡£¡£¡£¡£¡£¡£¡£¡
	
	I2C_SendData(IICx, ReadAdd);  //·¢ËÍ´æ´¢µØÖ·
	i = 0;
	//
	//EV8
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_TRANSMITTING))
	{
		i++;
		if (i > 2000)
		{
			*err |= 1<<3;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_GenerateSTART(IICx, ENABLE);  //ÖØÆôĞÅºÅ
	i = 0;
	//
	//EV5
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_MODE_SELECT))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<4;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	I2C_Send7bitAddress(IICx, SlaveAdd, I2C_Direction_Receiver);  //¶ÁÈ¡ÃüÁî
	i = 0;
	//
	//EV6
	//
	while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED))
	{
		i++;
		if (i > 800)
		{
			*err |= 1<<5;
			I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
			return;
		}
	}
	sta = IICx->SR2;  //Èí¼ş¶ÁÈ¡SR1¼Ä´æÆ÷ºó,¶ÔSR2¼Ä´æÆ÷µÄ¶Á²Ù×÷½«Çå³ıADDRÎ»£¬²»¿ÉÉÙ£¡£¡£¡£¡£¡£¡£¡£¡£¡
	//
	//ÅúÁ¿½ÓÊÕÊı¾İ
	//
//	while (NumToRead--)
//	{
//		if (NumToRead == 1)  //×îºóÒ»¸öÊı¾İÁË£¬²»·¢ËÍÓ¦´ğĞÅºÅ
//		{
//			I2C_AcknowledgeConfig(IICx, DISABLE);  //·¢ËÍNACK
//			I2C_GenerateSTOP(IICx, ENABLE);
//		}
//		//
//		//ÅĞ¶ÏRxNEÊÇ·ñÎª1£¬EV7
//		//
//		i = 0;
//		while (!I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_RECEIVED))
//		{
//			i++;
//			if (i > 1000)
//			{
//				*err |= 1<<6;
//				I2C_GenerateSTOP(IICx, ENABLE);  //²úÉúÍ£Ö¹ĞÅºÅ
//				return;
//			}
//		}
//		*pBuffer = I2C_ReceiveData(IICx);
//		pBuffer++;
//	}
	while (NumToRead)
	{
		if (NumToRead == 1)  //×îºóÒ»¸öÊı¾İÁË£¬²»·¢ËÍÓ¦´ğĞÅºÅ
		{
			I2C_AcknowledgeConfig(IICx, DISABLE);  //·¢ËÍNACK
			I2C_GenerateSTOP(IICx, ENABLE);
		}
		//
		//ÅĞ¶ÏRxNEÊÇ·ñÎª1£¬EV7
		//
		if (I2C_CheckEvent(IICx, I2C_EVENT_MASTER_BYTE_RECEIVED))
		{
			*pBuffer = I2C_ReceiveData(IICx);
			pBuffer++;
			NumToRead--;
		}
	}
	I2C_AcknowledgeConfig(IICx, ENABLE);
}

/**
  *****************************************************************************
  * @Name   : AT24C02Ò³Ğ´º¯Êı
  *
  * @Brief  : none
  *
  * @Input  : I2Cx:       IIC×é
  *           SlaveAdd:   ×÷Îª´ÓÉè±¸Ê±Ê¶±ğµØÖ·
  *           WriteAdd:   Ğ´ÈëEEPROMÄÚ´æÆğÊ¼µØÖ·
  *           NumToWrite: Ğ´ÈëÊı¾İÁ¿
  *           *pBuffer:   Ğ´ÈëµÄÊı¾İ×é»º´æ
  *
  * @Output : *err:     ·µ»ØµÄ´íÎóÖµ
  *
  * @Return : none
  *****************************************************************************
**/
void Hard_IIC_PageWrite(I2C_TypeDef * IICx, u8 SlaveAdd, u8 WriteAdd, u8 NumToWrite, u8 * pBuffer, u8 * err)
{
	u8 Num_Page = 0;  //°´ÕÕÒ³´óĞ¡ĞèÒªĞ´ÈëµÄ´ÎÊı
	u8 Num_Remain = 0;  //Ò³Ğ´Ê£Óà×Ö½ÚÊı
	u8 Addr = 0;  //Êı¾İ¿éÊ×µØÖ·ÎªEEPROMÒ³ÊıÕûÊı±¶
	u8 cnt = 0;  //¼ÆÊı±äÁ¿
	
	Addr = WriteAdd % AT24Cxx_PageSize;  //¼ÆËãÊı¾İ¿éÊ×µØÖ·ÊÇ·ñÊÇÒ³´óĞ¡µÄÕûÊı±¶
	cnt = AT24Cxx_PageSize - Addr;
	Num_Page = NumToWrite / AT24Cxx_PageSize;  //µÃµ½´ÎÊı
	Num_Remain = NumToWrite % AT24Cxx_PageSize;  //Ê£Óà×Ö½ÚÊı
	//
	//ÅĞ¶ÏĞ´ÈëÊıÁ¿
	//
	if (Addr == 0)  //ÕûÊı±¶
	{
		if (Num_Page == 0)  //Èç¹ûĞ´ÈëµÄÊı¾İ¿é³¤¶ÈĞ¡ÓÚÒ³´óĞ¡
		{
			Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, Num_Remain, pBuffer, err);  //Ğ¡ÓÚÒ»¸öÒ³´óĞ¡Êı¾İ
			Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
		}
		else  //´óÓÚÒ»Ò³Êı¾İ
		{
			while (Num_Page--)  //°´ÕÕÒ³À´Ğ´
			{
				Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, AT24Cxx_PageSize, pBuffer, err);
				Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
				WriteAdd += AT24Cxx_PageSize;
				pBuffer += AT24Cxx_PageSize;
			}
			if (Num_Remain != 0)  //²»¹»Ò»¸öÒ³µÄÊı¾İ
			{
				Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, Num_Remain, pBuffer, err);  //Ğ¡ÓÚÒ»¸öÒ³´óĞ¡Êı¾İ
				Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
			}
		}
	}
	else  //²»ÊÇÕûÊı±¶
	{
		if (Num_Page == 0)  //Ğ¡ÓÚÒ»¸öÒ³µÄÊı¾İÁ¿
		{
			Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, Num_Remain, pBuffer, err);  //Ğ´ÈëĞ¡ÓÚÒ»¸öÒ³µÄÊı¾İÁ¿
			Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
		}
		else  //´óÓÚÒ»¸öÒ²Êı¾İÁ¿
		{
			//
			//ÖØĞÂ¼ÆËã
			//
			NumToWrite -= cnt;
			Num_Page = NumToWrite / AT24Cxx_PageSize;
			Num_Remain = NumToWrite % AT24Cxx_PageSize;
			
			if (cnt != 0)
			{
				Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, cnt, pBuffer, err);
				Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
				WriteAdd += cnt;
				pBuffer += cnt;
			}
			while (Num_Page--)  //°´ÕÕÒ³À´Ğ´
			{
				Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, AT24Cxx_PageSize, pBuffer, err);
				Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
				WriteAdd += AT24Cxx_PageSize;
				pBuffer += AT24Cxx_PageSize;
			}
			if (Num_Remain != 0)  //²»¹»Ò»¸öÒ³µÄÊı¾İ
			{
				Hard_IIC_WriteNByte(IICx, SlaveAdd, WriteAdd, Num_Remain, pBuffer, err);  //Ğ¡ÓÚÒ»¸öÒ³´óĞ¡Êı¾İ
				Hard_IICWaiteStandby(IICx, SlaveAdd);  //µÈ´ı²Ù×÷Íê³É
			}
		}
	}
}
